---
layout: post
comments: true
title: cloud-front/flare 동시사용시 문제발생
tags: [aws, 장애, domain]
date: 2017-02-02 T00:50:42 +09:00
---
거의 6개월만에 쓰는 블로그 ㅠㅠ..
새마음 새뜻으로 다시 블로그를 써보자!!
오늘 글의 주제는 aws를 쓰면서 생긴 장애를 써보자고 한다.
현재 작업하고 있는 상황상 aws를 많이 쓰게 되면서,
왠지 장애 씨리즈가 계속 될 듯 싶다.


## 문제의 상황
```
cloud-front  --> cloud-flare --> api-gateway

---
cloud-front : 최초 api 요청이 들어온 aws service
cloud-flare : cdn service 업체, 현재 dns용으로 사용 중
api-gateway : lambda function들을 route하기 위한 aws service
```
- 요상한 형태의 이유(재빠른 대응)
현재 하고 있는 작업상 api-gateway를 내가 원하는 때에 switch를 해야하기 때문이다. cloud-front는 global cdn service라 옵션 하나만 수정하더라도 반영되는 시간이 30~40분이 걸린다.
근데 현재 상황상 cloud-front에 연결된 api-gateway의 주소를 바꾸면 30분 이상이 걸린다는 소리이다.(폭풍장애는 어떻게.. ㅠㅠ)

- 스위쳐 역할로 cloud-flare를!
이를 해결하기 위해 cloud-front의 설정을 변경하지 않고, 연결하는 api-gateway의 주소를 바꾸기 위해서 cloud-flare를 붙였다. 즉, 스위쳐의 역할을 cloud-flare가 하는 것이다. 게다가 cloud-flare의 주소교체는 1분 미만으로 교체가 된다.

행복한 마음으로 sj님과 테스트를 진행하고 있었지만..
불안은 언제나 적중하지..

## 문제 발생

```
ERROR

Bad request

Generated by cloudfront (CloudFront)
```

api call을 하면 위 화면이 계속적으로 뜬다.

문제 상황을 조금 더 정리하자면 아래와 같다.
- cloud-front에는 접속한 로그가 남는다.
- api-gateway에는 접속에 관련한 로그가 남지 않는다.(안 들어온듯)
- cloud-flare는 디버그 도구가 없다.(있으면 알려주세요.. ㅠㅠ)
- (etc) 에러 화면의 cloudfront는 api-gateway에서 뿜는 에러이다. api-gateway에서 custom domain을 쓰게 되면 앞에 자체적으로 cloud-front를 이용하여 domain을 제공하게 된다.

위 팩트들을 정리하자면

**cloud-flare --> api-gateway 요청이 Bad request!!**

## 문제의 원인
**최초 cloud-front의 forwarding header 설정에 있었다.**

우리가 설정한 forwarding header는 all.
이 옵션의 의미는 최초 header를 다음 목적지까지 그대로 넘기라는 것.
이 옵션을 설정하면 cloud-flare도 덩달아서 받은것을 그대로 포워딩 한다. 하지만 포워딩을 할 때 header의 host도 그~~대로 넘긴다. ㅠㅠㅠ

정상적인 동작 시나리오에서는 cloud-flare는 header의 host를 api-gateway domain으로 바꾸어야 한다.하지만 header를 확인해보면 cloud-flare의 domain이 박혀있을 것이다. api-gateway 입장에서는 자신에게 온 요청을 받았는데 host를 살펴보니 자신의 domain이 아닌 요상한 요청을 받게 되는 것이다.

요약하자면
1. cloud-front의 포워딩 헤더 옵션은 cloud-flare에도 영향을 미친다.
2. cloud-flare에서는 header의 host까지 그대로 보낸다. (cloud-flare가 다음 목적지로 host를 고쳐줘야함..)
3. api-gateway는 host가 자신이 아닌 cloud-flare domain이 박힌 이상한 요청을 받는다
4. Bad-request 뿜뿜

문제의 원인이 확인된 이상 해결은 간단했다.

## 문제의 해결

cloud-front 포워딩 헤더 옵션을 whitelist로 설정하고,
포워딩을 원하는 header 내용들만 따로 설정.

실행해보니 잘 실행된다.


## 결론
느낌점은 cloud 시스템을 짬뽕으로 쓰지말자이다.
알 수 없는 이유를 겪었을 때 온라인상에서 도움을 받을 곳이 많이 없다. ㅠㅠ
오로지 직관에 의한 테스트로만 문제를 해결할 확률이 매우 높다. (js님, sj님 수고 많으셨어요 ㅠㅠ)
